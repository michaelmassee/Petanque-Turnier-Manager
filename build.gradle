
plugins {
    id 'java'
    id 'application'
}

group = 'de.petanqueturniermanager'
version = '1.0.0'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
    withJavadocJar()
    withSourcesJar()
}

repositories {
    mavenCentral()
}

// Configuration properties
def libreOfficePath = findProperty('libreoffice.path') ?: '/usr/lib/libreoffice'
def libreOfficeClassesPath = "${libreOfficePath}/program/classes"
def extensionId = 'de.petanqueturniermanager.PetanqueTurnierManager'

configurations {
    libreoffice
}

dependencies {

    implementation 'com.google.guava:guava:33.0.0-jre'
    implementation 'org.apache.commons:commons-lang3:3.14.0'
    implementation 'org.apache.commons:commons-collections4:4.4'
    implementation 'org.apache.commons:commons-text:1.11.0'
    implementation 'commons-io:commons-io:2.15.1'
    implementation 'org.apache.logging.log4j:log4j-core:2.23.0'
    implementation 'org.kohsuke:github-api:1.318'
    implementation 'com.google.code.gson:gson:2.10.1'
    implementation 'io.github.g00fy2:versioncompare:1.5.0'
    implementation 'org.jsoup:jsoup:1.17.2'
    implementation 'com.opencsv:opencsv:5.9'

    // LibreOffice SDK dependencies - using local installation
    compileOnly fileTree(dir: libreOfficeClassesPath, include: ['*.jar'])
    compileOnly files(
        "${libreOfficeClassesPath}/ridl.jar",
        "${libreOfficeClassesPath}/unoil.jar",
        "${libreOfficeClassesPath}/jurt.jar",
        "${libreOfficeClassesPath}/juh.jar"
    )
    
    // LibreOffice SDK für Tests - use testImplementation so classes are available at runtime
    testImplementation fileTree(dir: libreOfficeClassesPath, include: ['*.jar'])
    testImplementation files(
        "${libreOfficeClassesPath}/ridl.jar",
        "${libreOfficeClassesPath}/unoil.jar",
        "${libreOfficeClassesPath}/jurt.jar",
        "${libreOfficeClassesPath}/juh.jar"
    )

    testImplementation 'junit:junit:4.13.2'
    testImplementation 'org.assertj:assertj-core:3.25.3'
    testImplementation 'org.mockito:mockito-core:3.12.4'
    testImplementation 'org.powermock:powermock-api-mockito2:2.0.9'
}

configurations.all {
	exclude group: 'commons-collections', module: 'commons-collections'
}

application {
    mainClass = 'de.petanqueturniermanager.SheetRunner'
}

task cleanCache (type: Delete) {
  delete "dist/.ooo-debug/user/uno_packages/cache"
}

task copyRuntimeLibs(type: Sync) {
    group = 'LibreOffice'
    description = 'Kopiert Runtime-Dependencies für die OXT'
    from configurations.runtimeClasspath
    into "$buildDir/runtime-libs"
}

// Task zum Erstellen des JAR mit UNO Registration
task buildPluginJar(type: Jar) {
    group = 'LibreOffice'
    description = 'Erstellt das JAR mit UNO Registration und Class-Path zu libs'
    dependsOn classes, copyRuntimeLibs
    archiveFileName.set("${project.name}-${version}.jar")
    
    from sourceSets.main.output
    
    manifest {
        attributes(
            'RegistrationClassName': 'de.petanqueturniermanager.comp.RegistrationHandler',
            'Class-Path': configurations.runtimeClasspath.collect { 
                "libs/${it.name}" 
            }.join(' ')
        )
    }
}

// Task zum Erstellen der OXT-Datei (LibreOffice Extension)
task buildOXT(type: Zip) {
    group = 'LibreOffice'
    description = 'Erstellt die OXT-Datei (LibreOffice Extension)'
    dependsOn buildPluginJar, copyRuntimeLibs
    archiveFileName.set("${project.name}-${version}.oxt")
    destinationDirectory.set(file("$buildDir/distributions"))
    
    // JAR-Datei hinzufügen
    from(buildPluginJar.archiveFile) {
        into ''
    }
    
    // META-INF manifest
    from('META-INF') {
        into 'META-INF'
    }
    
    // Description and configuration files
    from('.') {
        include 'description.xml'
    }
    
    from('description') {
        include '*.txt'
        into 'description'
    }
    
    // Registry configuration (XCU files)
    from('registry') {
        into 'registry'
    }
    
    // Images
    from('images') {
        into 'images'
    }
    
    // Runtime dependencies (libs)
    from("$buildDir/runtime-libs") {
        into 'libs'
    }
    
    // IDL files
    from('idl') {
        into 'idl'
    }
    
    // URD files (compiled IDL)
    from('build/urd') {
        into 'urd'
    }
}

// Task zum Installieren der Extension in LibreOffice
task installExtension(type: Exec) {
    group = 'LibreOffice'
    description = 'Installiert die erstellte Extension in LibreOffice'
    dependsOn buildOXT
    def oxtFile = "${buildDir}/distributions/${project.name}-${version}.oxt"
    commandLine 'unopkg', 'add', '-f', oxtFile
    
    doFirst {
        println "Installiere Extension: ${oxtFile}"
    }
}

// Task zum Deinstallieren der Extension
task uninstallExtension(type: Exec) {
    group = 'LibreOffice'
    description = 'Deinstalliert die Extension aus LibreOffice'
    commandLine 'unopkg', 'remove', extensionId
    ignoreExitValue = true
    
    doFirst {
        println "Deinstalliere Extension: ${extensionId}"
    }
}

// Task zum Neuinstallieren
task reinstallExtension {
    group = 'LibreOffice'
    description = 'De-/Neuinstallation der Extension'
    dependsOn uninstallExtension, installExtension
    installExtension.mustRunAfter uninstallExtension
}

// Debug-Task: Startet LibreOffice mit Debug-Port
task debugLibreOffice(type: Exec) {
    group = 'LibreOffice'
    description = 'Startet LibreOffice im Debug-Modus mit JDWP'
    dependsOn reinstallExtension
    
    environment 'JAVA_TOOL_OPTIONS', '-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=*:5005'
    
    commandLine 'libreoffice', '--calc'
    
    doFirst {
        println "LibreOffice wird im Debug-Modus gestartet..."
        println "Verbinde deinen Debugger mit Port 5005"
    }
}

// Build-Task
task buildPlugin {
    group = 'LibreOffice'
    description = 'High-level Task: Baut die OXT und zeigt Ausgabepfad'
    dependsOn buildOXT

    doLast {
        println "Plugin erfolgreich gebaut: ${buildDir}/distributions/${project.name}-${version}.oxt"
    }
}
