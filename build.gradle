
plugins {
    id 'java'
    id 'application'
}

group = 'de.petanqueturniermanager'
version = '1.0.0'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
    withJavadocJar()
    withSourcesJar()
}

repositories {
    // You can declare any Maven/Ivy/file repository here.
    jcenter()
    mavenCentral()
}

// Configuration properties
def libreOfficePath = findProperty('libreoffice.path') ?: '/usr/lib/libreoffice'
def libreOfficeClassesPath = "${libreOfficePath}/program/classes"
def extensionId = 'de.petanqueturniermanager.PetanqueTurnierManager'

configurations {
    libreoffice
}

dependencies {

    implementation 'com.google.guava:guava:33.0.0-jre'
    implementation 'org.apache.commons:commons-lang3:3.+'
    implementation 'org.apache.commons:commons-collections4:4.4'
    implementation 'org.apache.commons:commons-text:1.+'
    implementation 'commons-io:commons-io:2.+'
    implementation 'org.apache.logging.log4j:log4j-core:2.+'
    implementation 'org.kohsuke:github-api:1.+'
    implementation 'com.google.code.gson:gson:2.10.+'
    implementation 'io.github.g00fy2:versioncompare:1.5.0'
    implementation 'org.jsoup:jsoup:1.+'   // html parser
    implementation 'com.opencsv:opencsv:+'  // csv reader and writer

    // LibreOffice SDK dependencies - using local installation
    compileOnly fileTree(dir: libreOfficeClassesPath, include: ['*.jar'])
    compileOnly files(
        "${libreOfficeClassesPath}/ridl.jar",
        "${libreOfficeClassesPath}/unoil.jar",
        "${libreOfficeClassesPath}/jurt.jar",
        "${libreOfficeClassesPath}/juh.jar"
    )

    testImplementation 'junit:junit:4.+'
    testImplementation 'org.assertj:assertj-core:3.+'
    testImplementation 'org.mockito:mockito-core:3.+'
    testImplementation 'org.powermock:powermock-api-mockito2:2.+'
}

configurations.all {
	exclude group: 'commons-collections', module: 'commons-collections'
}

application {
    mainClass = 'de.petanqueturniermanager.SheetRunner'
}

task cleanCache (type: Delete) {
  delete "dist/.ooo-debug/user/uno_packages/cache"
}

task copyRuntimeLibs(type: Sync) {
   	from configurations.runtimeClasspath
   	into "libs"
}

// Task zum Erstellen des JAR mit UNO Registration
task buildPluginJar(type: Jar) {
    group = 'Build'
    description = 'Erstellt das JAR mit UNO Registration'
    dependsOn classes
    archiveFileName.set("${project.name}-${version}.jar")
    from sourceSets.main.output.classesDirs

    manifest {
        attributes(
            'RegistrationClassName': 'de.petanqueturniermanager.addins.GlobalImpl'
        )
    }
}

// Task zum Erstellen der OXT-Datei (LibreOffice Extension)
task buildOXT(type: Zip) {
    group = 'Build'
    description = 'Erstellt die OXT-Datei (LibreOffice Extension)'
    dependsOn buildPluginJar
    archiveFileName.set("${project.name}-${version}.oxt")
    destinationDirectory.set(file("$buildDir/distributions"))
    
    // JAR-Datei hinzuf√ºgen
    from(buildPluginJar.archiveFile) {
        into ''
    }
    
    // Manifest
    from('META-INF') {
        into 'META-INF'
    }
    
    // Description and configuration files
    from('.') {
        include 'description.xml'
    }
    
    from('description') {
        include '*.txt'
        into 'description'
    }
    
    from('registry') {
        into 'registry'
    }
    
    from('images') {
        into 'images'
    }
    
    // IDL files
    from('idl') {
        into 'idl'
    }
    
    // URD files
    from('build/urd') {
        into 'urd'
    }
}

// Task zum Installieren der Extension in LibreOffice
task installExtension(type: Exec) {
    group = 'Build'
    description = 'Installiert die erstellte Extension in LibreOffice'
    dependsOn buildOXT
    def oxtFile = "${buildDir}/distributions/${project.name}-${version}.oxt"
    commandLine 'unopkg', 'add', '-f', oxtFile
    
    doFirst {
        println "Installiere Extension: ${oxtFile}"
    }
}

// Task zum Deinstallieren der Extension
task uninstallExtension(type: Exec) {
    group = 'Build'
    description = 'Deinstalliert die Extension aus LibreOffice'
    commandLine 'unopkg', 'remove', extensionId
    ignoreExitValue = true
    
    doFirst {
        println "Deinstalliere Extension: ${extensionId}"
    }
}

// Task zum Neuinstallieren
task reinstallExtension {
    group = 'Build'
    description = 'De-/Neuinstallation der Extension'
    dependsOn uninstallExtension, installExtension
    installExtension.mustRunAfter uninstallExtension
}

// Debug-Task: Startet LibreOffice mit Debug-Port
task debugLibreOffice(type: Exec) {
    group = 'Build'
    description = 'Startet LibreOffice im Debug-Modus mit JDWP'
    dependsOn reinstallExtension
    
    environment 'JAVA_TOOL_OPTIONS', '-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=*:5005'
    
    commandLine 'libreoffice', '--calc'
    
    doFirst {
        println "LibreOffice wird im Debug-Modus gestartet..."
        println "Verbinde deinen Debugger mit Port 5005"
    }
}

// Build-Task
task buildPlugin {
    group = 'Build'
    description = 'High-level Task: Baut die OXT und zeigt Ausgabepfad'
    dependsOn buildOXT

    doLast {
        println "Plugin erfolgreich gebaut: ${buildDir}/distributions/${project.name}-${version}.oxt"
    }
}
